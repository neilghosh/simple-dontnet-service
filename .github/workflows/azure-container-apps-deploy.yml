name: Deploy to Azure Container Apps

# CI/CD Workflow for Azure Container Apps:
# - Pull Requests:  CI only (build, test) - No deployment
# - Push to main:   CI + CD (build, test, deploy to Container Apps)
# - Manual trigger: CI + CD with configurable parameters

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      region:
        description: 'Azure region for deployment'
        required: true
        default: 'eastus'
        type: choice
        options:
          - eastus
          - eastus2
          - westus
          - westus2
          - westeurope
          - northeurope
          - southeastasia
          - australiaeast

# Default configuration - can be overridden by workflow_dispatch inputs
env:
  DOTNET_VERSION: '8.0.x'
  # Azure Container Apps configuration
  CONTAINER_APP_NAME: 'simple-dotnet-service'
  CONTAINER_APP_ENV_NAME: 'simple-dotnet-service-env'
  RESOURCE_GROUP: 'simple-dotnet-service-rg'
  # Default region (overridden by workflow_dispatch input)
  AZURE_REGION: ${{ github.event.inputs.region || 'eastus' }}
  # Container Registry (auto-created by az containerapp up)
  IMAGE_NAME: 'simple-dotnet-service'
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ============================================================================
  # CI: Build and Test
  # ============================================================================
  ci:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore simple-dotnet-service.sln
    
    - name: Build solution
      run: dotnet build simple-dotnet-service.sln --configuration Release --no-restore
    
    - name: Run tests
      run: dotnet test simple-dotnet-service.sln --configuration Release --no-build --verbosity normal

  # ============================================================================
  # CD: Deploy to Azure Container Apps
  # ============================================================================
  cd:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Display deployment configuration
      run: |
        echo "üöÄ Deployment Configuration:"
        echo "   Region: ${{ env.AZURE_REGION }}"
        echo "   Resource Group: ${{ env.RESOURCE_GROUP }}"
        echo "   Container App: ${{ env.CONTAINER_APP_NAME }}"
        echo "   Image Tag: ${{ env.IMAGE_TAG }}"

    # ========================================================================
    # Azure Authentication using OIDC (Federated Identity)
    # ========================================================================
    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # ========================================================================
    # Deploy to Azure Container Apps
    # ========================================================================
    - name: Install Azure Container Apps extension
      run: |
        az extension add --name containerapp --upgrade --yes || true
        # Register providers (may already be registered)
        az provider register --namespace Microsoft.App || true
        az provider register --namespace Microsoft.OperationalInsights || true

    - name: Create or update Resource Group
      run: |
        az group create \
          --name ${{ env.RESOURCE_GROUP }} \
          --location ${{ env.AZURE_REGION }} \
          --output none || true

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp up \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --location ${{ env.AZURE_REGION }} \
          --source . \
          --ingress external \
          --target-port 8080 \
          --env-vars ASPNETCORE_ENVIRONMENT=Production

    # ========================================================================
    # Deployment Verification
    # ========================================================================
    - name: Get Container App URL
      id: get-url
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        echo "url=https://${APP_URL}" >> $GITHUB_OUTPUT
        echo "üåê Container App URL: https://${APP_URL}"

    - name: Verify deployment
      run: |
        HEALTH_URL="${{ steps.get-url.outputs.url }}/api/ip/outbound"
        echo "Testing endpoint: ${HEALTH_URL}"
        
        for i in {1..10}; do
          echo "Attempt ${i}/10..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${HEALTH_URL}" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Deployment successful! API is responding."
            curl -s "${HEALTH_URL}" | jq . || curl -s "${HEALTH_URL}"
            exit 0
          fi
          
          echo "   Status: ${HTTP_STATUS} - Waiting 15 seconds..."
          sleep 15
        done
        
        echo "‚ùå Deployment verification failed after 10 attempts"
        exit 1

    - name: Deployment Summary
      if: success()
      run: |
        echo "=============================================="
        echo "üéâ DEPLOYMENT SUCCESSFUL"
        echo "=============================================="
        echo "üìç Region: ${{ env.AZURE_REGION }}"
        echo "üîó URL: ${{ steps.get-url.outputs.url }}"
        echo "üì¶ Image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
        echo "=============================================="
